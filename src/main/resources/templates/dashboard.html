<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV SWAP Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
</head>
<body class="dashboard-body">
<div class="background-gradient"></div>
<div class="background-glow"></div>

<header class="top-nav">
    <div class="container nav-inner">
        <div class="brand">
            <!-- Logo thay cho emoji -->
            <img th:src="@{/images/logo.jpg}" src="/images/logo.jpg" alt="EV SWAP" class="brand-logo">
            <span class="brand-name">EV SWAP</span>
        </div>
        <nav class="nav-links" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
            <a th:if="${loggedIn}" th:href="@{/dashboard}" class="nav-link-button">T·ªïng quan</a>
            <a th:if="${loggedIn}" th:href="@{/vehicles}" class="nav-link-button">Ph∆∞∆°ng ti·ªán</a>
            <a th:if="${loggedIn}" th:href="@{/stations}" class="nav-link-button">T√¨m tr·∫°m</a>
            <a th:if="${loggedIn}" th:href="@{/reports}" class="nav-link-button">B√°o c√°o</a>
            <a th:if="${loggedIn}" th:href="@{/account}" class="nav-link-button">T√†i kho·∫£n</a>
            <a th:if="${loggedIn}" th:href="@{/support}" class="nav-link-button">H·ªó tr·ª£</a>

            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="T·ªïng quan">T·ªïng quan</button>
            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="Ph∆∞∆°ng ti·ªán">Ph∆∞∆°ng ti·ªán</button>
            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="T√¨m tr·∫°m">T√¨m tr·∫°m</button>
            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="B√°o c√°o">B√°o c√°o</button>
            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="T√†i kho·∫£n">T√†i kho·∫£n</button>
            <button th:if="${!loggedIn}" type="button" class="nav-link-button nav-link-button--locked" data-feature="H·ªó tr·ª£">H·ªó tr·ª£</button>
        </nav>
        <div class="notification-area" th:if="${loggedIn}">
            <button type="button"
                    class="notification-bell"
                    id="notificationToggle"
                    aria-haspopup="true"
                    aria-expanded="false"
                    aria-controls="notificationDropdown">
                <span class="bell-icon" aria-hidden="true">üîî</span>
                <span class="notification-badge"
                      id="notificationCount"
                      th:text="${notificationCount != null ? notificationCount : 0}"
                      th:classappend="${notificationCount == null || notificationCount == 0} ? ' is-hidden' : ''"></span>
                <span class="sr-only">Th√¥ng b√°o</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown" hidden>
                <div class="notification-dropdown__header">
                    <h4>Th√¥ng b√°o</h4>
                    <button type="button"
                            class="mark-all"
                            id="markAllNotifications"
                            th:classappend="${notificationCount == null || notificationCount == 0} ? ' is-hidden' : ''">ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc</button>
                </div>
                <ul class="notification-list" id="notificationList">
                    <li class="notification-empty"
                        th:if="${notifications == null || notifications.isEmpty()}">Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.</li>
                    <li class="notification-item"
                        th:each="notification : ${notifications}"
                        th:classappend="${notification.read()} ? ' is-read'">
                        <div class="notification-item__content">
                            <h5 th:text="${notification.title()}">B·∫°n c√≥ th√¥ng b√°o m·ªõi</h5>
                            <p>
                                <span class="notification-item__type"
                                      th:text="${notification.type() != null ? notification.type() : 'H·ªá th·ªëng'}">H·ªá th·ªëng</span>
                                ¬∑
                                <span class="notification-item__time"
                                      th:text="${#temporals.format(notification.sentAt(), 'HH:mm dd/MM/yyyy')}">10:00 01/01/2024</span>
                            </p>
                        </div>
                        <button type="button"
                                class="mark-read"
                                th:if="${!notification.read()}"
                                th:attr="data-notification-id=${notification.id()}">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="auth-area" th:if="${loggedIn}">
            <span class="welcome">Xin ch√†o, <strong th:text="${driverName}">ng∆∞·ªùi d√πng</strong>!</span>
            <form th:action="@{/logout}" method="post">
                <button class="btn ghost" type="submit">ƒêƒÉng xu·∫•t</button>
            </form>
        </div>
        <div class="auth-area" th:if="${!loggedIn}">
            <a class="btn ghost" th:href="@{/login}">ƒêƒÉng nh·∫≠p</a>
            <a class="btn primary" th:href="@{/register}">ƒêƒÉng k√Ω</a>
        </div>
    </div>
</header>

<main>
    <div class="container">
        <p class="alert" th:if="${loginSuccess}" th:text="${loginSuccess}"></p>
    </div>

    <!-- Hero: d√πng ·∫£nh local /images/hero.jpg -->
    <section id="overview" class="hero-banner">
        <img th:src="@{/images/hero.jpg}"
             src="/images/hero.jpg"
             alt="H√¨nh ·∫£nh ph∆∞∆°ng ti·ªán ƒëi·ªán hi·ªán ƒë·∫°i"
             class="hero-banner__image"
             loading="lazy">
    </section>

    <section class="stats-section container">
        <article class="stat-card">
            <header>
                <h3>50+</h3>
                <p>Tr·∫°m ƒë·ªïi pin</p>
            </header>
            <p>Ph·ªß s√≥ng kh·∫Øp c√°c th√†nh ph·ªë l·ªõn, lu√¥n s·∫µn s√†ng ph·ª•c v·ª• b·∫°n m·ªçi l√∫c.</p>
        </article>
        <article class="stat-card">
            <header>
                <h3>3 ph√∫t</h3>
                <p>Th·ªùi gian ƒë·ªïi</p>
            </header>
            <p>Quy tr√¨nh t·ª± ƒë·ªông v√† an to√†n, r√∫t ng·∫Øn t·ªëi ƒëa th·ªùi gian ch·ªù ƒë·ª£i.</p>
        </article>
        <article class="stat-card">
            <header>
                <h3>24/7</h3>
                <p>D·ªãch v·ª•</p>
            </header>
            <p>ƒê·ªôi ng≈© h·ªó tr·ª£ t·∫≠n t√¢m, ƒë·∫£m b·∫£o h√†nh tr√¨nh c·ªßa b·∫°n kh√¥ng b·ªã gi√°n ƒëo·∫°n.</p>
        </article>
    </section>

    <section id="benefits" class="feature-section container">
        <div class="section-header">
            <span class="section-badge">T√≠nh nƒÉng</span>
            <h2 class="section-title">T·∫°i sao ch·ªçn EV SWAP?</h2>
            <p class="section-description">Gi·∫£i ph√°p ƒë·ªïi pin th√¥ng minh v·ªõi c√¥ng ngh·ªá ti√™n ti·∫øn v√† d·ªãch v·ª• t·ªëi nh·∫•t d√†nh cho ng∆∞·ªùi d√πng xe m√°y ƒëi·ªán.</p>
        </div>
        <div class="feature-grid">
            <article class="feature-card">
                <div class="feature-icon">‚ö°</div>
                <h3>Si√™u nhanh 3 ph√∫t</h3>
                <p>Ch·ªâ m·∫•t 3 ph√∫t ƒë·ªÉ thay pin, s·∫µn s√†ng ti·∫øp t·ª•c h√†nh tr√¨nh m√† kh√¥ng c·∫ßn ch·ªù s·∫°c.</p>
            </article>
            <article class="feature-card">
                <div class="feature-icon">üåê</div>
                <h3>M·∫°ng l∆∞·ªõi r·ªông kh·∫Øp</h3>
                <p>H∆°n 50 tr·∫°m ph·ªß kh·∫Øp c·∫£ n∆∞·ªõc, lu√¥n trong b√°n k√≠nh d∆∞·ªõi 5km.</p>
            </article>
            <article class="feature-card">
                <div class="feature-icon">üõ°Ô∏è</div>
                <h3>An to√†n tuy·ªát ƒë·ªëi</h3>
                <p>Pin ƒë∆∞·ª£c ki·ªÉm ƒë·ªãnh nghi√™m ng·∫∑t, ƒë·∫£m b·∫£o an to√†n cho ng∆∞·ªùi d√πng v√† ph∆∞∆°ng ti·ªán.</p>
            </article>
        </div>
    </section>

    <section class="feature-section container">
        <div class="feature-grid">
            <article class="feature-card">
                <div class="feature-icon">üí∞</div>
                <h3>Ti·∫øt ki·ªám chi ph√≠</h3>
                <p>Ch·ªâ 25.000ƒë m·ªói l·∫ßn ƒë·ªïi. Ti·∫øt ki·ªám 60% so v·ªõi xƒÉng truy·ªÅn th·ªëng.</p>
            </article>
            <article class="feature-card">
                <div class="feature-icon">üïí</div>
                <h3>Ho·∫°t ƒë·ªông 24/7</h3>
                <p>Tr·∫°m ƒë·ªïi pin ph·ª•c v·ª• kh√¥ng ng·ª´ng ngh·ªâ, h·ªó tr·ª£ m·ªçi nhu c·∫ßu di chuy·ªÉn.</p>
            </article>
            <article class="feature-card">
                <div class="feature-icon">üå±</div>
                <h3>Th√¢n thi·ªán m√¥i tr∆∞·ªùng</h3>
                <p>Gi·∫£m ph√°t th·∫£i CO<sub>2</sub>, g√≥p ph·∫ßn x√¢y d·ª±ng t∆∞∆°ng lai giao th√¥ng xanh.</p>
            </article>
        </div>
    </section>

    <section id="account" class="cta-section">
        <div class="container cta-inner">
            <div class="cta-content">
                <h2>S·∫µn s√†ng chuy·ªÉn ƒë·ªïi sang t∆∞∆°ng lai xanh?</h2>
                <p>Gia nh·∫≠p c·ªông ƒë·ªìng h∆°n 10,000 t√†i x·∫ø s·ª≠ d·ª•ng EV SWAP. Tr·∫£i nghi·ªám c√¥ng ngh·ªá ƒë·ªïi pin th√¥ng minh ngay h√¥m nay.</p>
            </div>
            <div class="cta-actions">
                <a th:href="@{/register}" class="btn primary">ƒêƒÉng k√Ω ngay</a>
                <a th:href="@{/login}" class="btn outline">ƒê√£ c√≥ t√†i kho·∫£n</a>
            </div>
        </div>
    </section>

    <section id="stations" class="preview-section container">
        <div class="preview-card">
            <div class="preview-header">
                <!-- D√πng logo ·ªü th·∫ª preview lu√¥n cho ƒë·ªìng b·ªô -->
                <img th:src="@{/images/logo.jpg}" src="/images/logo.jpg" alt="EV SWAP" class="brand-logo">
                <h3>EV SWAP</h3>
                <p>H·ªá th·ªëng ƒë·ªïi pin xe m√°y ƒëi·ªán th√¥ng minh nh·∫•t Vi·ªát Nam.</p>
            </div>
            <ul class="preview-list">
                <li>ƒê·ªïi pin si√™u nhanh</li>
                <li>M·∫°ng l∆∞·ªõi r·ªông kh·∫Øp</li>
                <li>An to√†n tuy·ªát ƒë·ªëi</li>
            </ul>
            <a th:href="@{/login}" class="btn ghost full">ƒêƒÉng nh·∫≠p</a>
        </div>
        <div class="preview-card dark">
            <h3>H·ªó tr·ª£ ∆∞u ti√™n</h3>
            <p>K√≠ch ho·∫°t t√†i kho·∫£n ƒë·ªÉ nh·∫≠n t∆∞ v·∫•n ri√™ng v√† ƒë·∫∑c quy·ªÅn chƒÉm s√≥c kh√°ch h√†ng.</p>
            <ul class="preview-list">
                <li>ƒê·ªôi ng≈© tr·ª±c 24/7</li>
                <li>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng chi ti·∫øt</li>
                <li>∆Øu ƒë√£i d√†nh ri√™ng h·ªôi vi√™n</li>
            </ul>
            <a th:href="@{/register}" class="btn primary full">Tham gia ngay</a>
        </div>
    </section>

    <section class="footer container">
        <p th:if="${dashboardMessage}" th:text="${dashboardMessage}" class="footer-message"></p>
        <p class="footer-note">¬© 2025 EV SWAP. M·∫°ng l∆∞·ªõi ƒë·ªïi pin xe m√°y ƒëi·ªán th√¥ng minh ƒë·∫ßu ti√™n t·∫°i Vi·ªát Nam.</p>
    </section>
</main>

<div class="login-modal" id="login-modal" role="dialog" aria-modal="true" aria-labelledby="login-modal-title" hidden>
    <div class="login-modal__overlay" onclick="closeLoginModal()"></div>
    <div class="login-modal__dialog">
        <button type="button" class="login-modal__close" aria-label="ƒê√≥ng" onclick="closeLoginModal()">√ó</button>
        <div class="login-modal__content">
            <div class="login-showcase">
                <!-- Logo trong modal -->
                <img th:src="@{/images/logo.jpg}" src="/images/logo.jpg" alt="EV SWAP" class="brand-logo brand-logo--showcase">
                <h3 id="login-modal-title">EV SWAP</h3>
                <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p ƒë·∫ßy ƒë·ªß c√°c ch·ª©c nƒÉng ƒë·ªïi pin th√¥ng minh.</p>
                <ul>
                    <li>Qu·∫£n l√Ω ph∆∞∆°ng ti·ªán v√† ƒë·ªïi pin</li>
                    <li>Theo d√µi l·ªãch s·ª≠ ho√° ƒë∆°n</li>
                    <li>Nh·∫≠n h·ªó tr·ª£ ∆∞u ti√™n 24/7</li>
                </ul>
            </div>
            <div class="login-form-card">
                <h4>ƒêƒÉng nh·∫≠p t√†i kho·∫£n</h4>
                <p class="login-alert">Vui l√≤ng ƒëƒÉng nh·∫≠p ho·∫∑c ƒëƒÉng k√≠ ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng.</p>
                <form th:action="@{/login}" method="post">
                    <div class="input-group">
                        <label for="modal-email">Email</label>
                        <input id="modal-email" name="email" type="email" placeholder="example@email.com" required>
                    </div>
                    <div class="input-group">
                        <label for="modal-password">M·∫≠t kh·∫©u</label>
                        <input id="modal-password" name="password" type="password" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn primary full">ƒêƒÉng nh·∫≠p</button>
                </form>
                <p class="register-hint">Ch∆∞a c√≥ t√†i kho·∫£n? <a th:href="@{/register}">ƒêƒÉng k√Ω ngay</a></p>
            </div>
        </div>
    </div>
</div>

<script>
    const loginModal = document.getElementById('login-modal');
    const modalEmailInput = document.getElementById('modal-email');

    function openLoginModal() {
        if (loginModal) {
            loginModal.removeAttribute('hidden');
            document.body.classList.add('modal-open');
            if (modalEmailInput) {
                modalEmailInput.focus();
            }
        }
    }

    function closeLoginModal() {
        if (loginModal) {
            loginModal.setAttribute('hidden', '');
            document.body.classList.remove('modal-open');
        }
    }

    // G·∫Øn m·ªü modal cho c√°c n√∫t b·ªã kh√≥a khi ch∆∞a ƒëƒÉng nh·∫≠p
    document.querySelectorAll('.nav-link-button--locked').forEach(function (button) {
        button.addEventListener('click', function (event) {
            event.preventDefault();
            openLoginModal();
        });
    });

    window.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && loginModal && !loginModal.hasAttribute('hidden')) {
            closeLoginModal();
        }
    });

    const notificationToggle = document.getElementById('notificationToggle');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationList = document.getElementById('notificationList');
    const notificationCountBadge = document.getElementById('notificationCount');
    const markAllNotificationsButton = document.getElementById('markAllNotifications');
    const notificationArea = document.querySelector('.notification-area');
    let unreadCount = notificationCountBadge ? Number(notificationCountBadge.textContent) || 0 : 0;

    function updateBadge(value) {
        if (!notificationCountBadge) {
            return;
        }
        unreadCount = value;
        notificationCountBadge.textContent = value;
        if (value > 0) {
            notificationCountBadge.classList.remove('is-hidden');
        } else {
            notificationCountBadge.classList.add('is-hidden');
        }
    }

    function toggleMarkAllButton(visible) {
        if (!markAllNotificationsButton) {
            return;
        }
        markAllNotificationsButton.classList.toggle('is-hidden', !visible);
    }

    function formatInstant(instant) {
        if (!instant) {
            return '';
        }
        const date = new Date(instant);
        if (Number.isNaN(date.getTime())) {
            return '';
        }
        return date.toLocaleString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }

    function escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value).replace(/[&<>"']/g, function (char) {
            switch (char) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case '\'':
                    return '&#39;';
                default:
                    return char;
            }
        });
    }

    function renderNotifications(notifications) {
        if (!notificationList) {
            return;
        }

        if (!notifications || notifications.length === 0) {
            notificationList.innerHTML = '<li class="notification-empty">Ch∆∞a c√≥ th√¥ng b√°o m·ªõi.</li>';
            return;
        }

        const items = notifications.map(function (notification) {
            const readClass = notification.read ? ' is-read' : '';
            const markButton = notification.read
                ? ''
                : '<button type="button" class="mark-read" data-notification-id="' + notification.id + '">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>';

            return '<li class="notification-item' + readClass + '" data-notification-id="' + notification.id + '">'
                + '<div class="notification-item__content">'
                + '<h5>' + escapeHtml(notification.title) + '</h5>'
                + '<p>'
                + '<span class="notification-item__type">' + escapeHtml(notification.type || 'H·ªá th·ªëng') + '</span>'
                + ' ¬∑ '
                + '<span class="notification-item__time">' + escapeHtml(formatInstant(notification.sentAt)) + '</span>'
                + '</p>'
                + '</div>'
                + markButton
                + '</li>';
        }).join('');

        notificationList.innerHTML = items;
    }

    async function loadNotifications() {
        if (!notificationDropdown) {
            return;
        }
        try {
            const response = await fetch('/api/notifications');
            if (!response.ok) {
                return;
            }
            const data = await response.json();
            renderNotifications(data.notifications);
            updateBadge(Number(data.unreadCount) || 0);
            toggleMarkAllButton((Number(data.unreadCount) || 0) > 0);
        } catch (error) {
            console.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o', error);
        }
    }

    async function markNotificationAsRead(notificationId) {
        try {
            const response = await fetch('/api/notifications/' + notificationId + '/read', {
                method: 'POST'
            });
            return response.ok;
        } catch (error) {
            console.error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√¥ng b√°o', error);
            return false;
        }
    }

    async function markAllAsRead() {
        try {
            const response = await fetch('/api/notifications/read-all', {
                method: 'POST'
            });
            return response.ok;
        } catch (error) {
            console.error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t·∫•t c·∫£ th√¥ng b√°o', error);
            return false;
        }
    }

    if (notificationToggle && notificationDropdown) {
        notificationToggle.addEventListener('click', function () {
            const isHidden = notificationDropdown.hasAttribute('hidden');
            if (isHidden) {
                notificationDropdown.removeAttribute('hidden');
                notificationToggle.setAttribute('aria-expanded', 'true');
                loadNotifications();
            } else {
                notificationDropdown.setAttribute('hidden', '');
                notificationToggle.setAttribute('aria-expanded', 'false');
            }
        });

        document.addEventListener('click', function (event) {
            if (!notificationArea) {
                return;
            }
            if (!notificationArea.contains(event.target)) {
                notificationDropdown.setAttribute('hidden', '');
                notificationToggle.setAttribute('aria-expanded', 'false');
            }
        });
    }

    if (notificationList) {
        notificationList.addEventListener('click', function (event) {
            const button = event.target.closest('.mark-read');
            if (!button) {
                return;
            }
            const notificationId = button.getAttribute('data-notification-id');
            if (!notificationId) {
                return;
            }

            markNotificationAsRead(notificationId).then(function (success) {
                if (!success) {
                    return;
                }
                const listItem = button.closest('.notification-item');
                if (listItem) {
                    listItem.classList.add('is-read');
                }
                button.remove();
                const nextValue = Math.max(0, unreadCount - 1);
                updateBadge(nextValue);
                toggleMarkAllButton(nextValue > 0);
            });
        });
    }

    if (markAllNotificationsButton) {
        markAllNotificationsButton.addEventListener('click', function () {
            markAllAsRead().then(function (success) {
                if (!success) {
                    return;
                }
                if (notificationDropdown) {
                    notificationDropdown.querySelectorAll('.notification-item').forEach(function (item) {
                        item.classList.add('is-read');
                        const actionButton = item.querySelector('.mark-read');
                        if (actionButton) {
                            actionButton.remove();
                        }
                    });
                }
                updateBadge(0);
                toggleMarkAllButton(false);
            });
        });
    }
</script>
</body>
</html>
