<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m tr·∫°m - EV SWAP</title>

    <link rel="stylesheet" th:href="@{/css/station.css}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 450px;
            width: 100%;
            border-radius: var(--radius-md);
            margin-bottom: 24px; /* Th√™m margin d∆∞·ªõi */
            border: 1px solid var(--border-soft);
            box-shadow: var(--shadow-soft);
            z-index: 5;
        }
        .search-form {
            display: flex; gap: 12px;
            margin-bottom: 24px; align-items: center;
        }
        .search-form input[type="text"] { flex-grow: 1; }
    </style>
</head>

<body class="dashboard-body">

<div class="background-gradient"></div>
<div class="background-glow"></div>

<header class="manage-header container">
    <div class="driver-identity">
        <div class="driver-avatar">üìç</div>
        <div class="driver-intro">
            <span class="subtitle">T√¨m ki·∫øm tr·∫°m</span>
            <h1 class="page-title">EV SWAP Stations</h1>
            <p class="page-hint">
                T√¨m ki·∫øm tr·∫°m ƒë·ªïi pin g·∫ßn b·∫°n m·ªôt c√°ch nhanh ch√≥ng.
            </p>
        </div>
    </div>
    <div class="header-actions">
        <a class="btn ghost" th:href="@{/dashboard}">Quay v·ªÅ Dashboard</a>
    </div>
</header>

<main class="manage-main container">

    <div class="alert error" th:if="${param.error}">
        Kh√¥ng t√¨m th·∫•y tr·∫°m b·∫°n y√™u c·∫ßu.
    </div>

    <section class="station-map-section">
        <h2>B·∫£n ƒë·ªì tr·∫°m</h2>
        <div id="map"></div>
    </section>

    <section class="station-nearby-section">
        <h2>T√¨m tr·∫°m g·∫ßn v·ªã tr√≠ c·ªßa b·∫°n</h2>

        <form id="nearby-form" method="get" th:action="@{/stations/nearby}">
            <input type="hidden" name="lat" id="latitude">
            <input type="hidden" name="lng" id="longitude">
            <label for="radius-km">B√°n k√≠nh (km):</label>
            <input type="number" step="any" name="radiusKm" id="radius-km" value="5">
            <button type="button" class="btn primary" onclick="getLocation()">T√¨m tr·∫°m g·∫ßn v·ªã tr√≠ c·ªßa t√¥i</button>
        </form>

        <table th:if="${nearbyStations != null and not nearbyStations.isEmpty()}">
            <thead>
            <tr>
                <th>T√™n tr·∫°m</th>
                <th>Kho·∫£ng c√°ch (km)</th>
                <th>ƒê·ªãa ch·ªâ</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="st : ${nearbyStations}">
                <td th:text="${st.name}"></td>
                <td th:text="${#numbers.formatDecimal(st.distance, 1, 2)}"></td>
                <td th:text="${st.address}"></td>
            </tr>
            </tbody>
        </table>
        <div class="alert" th:if="${nearbyStations != null and nearbyStations.isEmpty()}" style="margin-top: 24px; text-align: center;">
            Kh√¥ng t√¨m th·∫•y tr·∫°m n√†o trong b√°n k√≠nh ƒë√£ ch·ªçn.
        </div>
    </section>

    <section class="station-list-section">
        <h2>Danh s√°ch t·∫•t c·∫£ tr·∫°m</h2>

        <form th:action="@{/stations}" method="get" class="search-form">
            <input type="text" name="name" placeholder="T√¨m theo t√™n tr·∫°m ho·∫∑c ƒë·ªãa ch·ªâ..." th:value="${searchName}" />
            <button class="btn primary" type="submit">T√¨m ki·∫øm</button>
            <a th:href="@{/stations}" class="btn ghost">Xem t·∫•t c·∫£</a>
        </form>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>T√™n tr·∫°m</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${stations == null or stations.isEmpty()}">
                <td colspan="5" style="text-align: center; padding: 32px;">Kh√¥ng t√¨m th·∫•y tr·∫°m n√†o.</td>
            </tr>
            <tr th:each="station : ${stations}">
                <td th:text="${station.stationId}"></td>
                <td th:text="${station.name}"></td>
                <td th:text="${station.address}"></td>
                <td>
                    <span th:text="${station.status == 'active' ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ ƒë√≥ng'}"
                          th:style="${station.status == 'active' ? 'color: var(--accent-success)' : 'color: var(--text-muted)'}">
                    </span>
                </td>
                <td>
                    <a class="btn ghost" th:href="@{|/stations/${station.stationId}|}">Xem chi ti·∫øt</a>
                </td>
            </tr>
            </tbody>
        </table>
    </section>

    <section class="station-detail-section" th:if="${station != null}">
        <h2>Chi ti·∫øt tr·∫°m</h2>
        <ul>
            <li><b>ID:</b> <span th:text="${station.stationId}"></span></li>
            <li><b>T√™n tr·∫°m:</b> <span th:text="${station.name}"></span></li>
            <li><b>ƒê·ªãa ch·ªâ:</b> <span th:text="${station.address}"></span></li>
            <li><b>Tr·∫°ng th√°i:</b>
                <span th:text="${station.status == 'active' ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ ƒë√≥ng'}"
                      th:style="${station.status == 'active' ? 'color: var(--accent-success)' : 'color: var(--text-muted)'}">
                </span>
            </li>
            <li><b>To·∫° ƒë·ªô:</b>
                <span th:text="${station.latitude}"></span>,
                <span th:text="${station.longitude}"></span>
            </li>
        </ul>
        <a class="btn ghost" th:href="@{/stations}">Quay l·∫°i danh s√°ch</a>
    </section>
</main>

<script th:inline="javascript">
    /*<![CDATA[*/

    // === PH·∫¶N T√åM V·ªä TR√ç ===
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
                document.getElementById('nearby-form').submit();
            }, function (error) {
                alert('B·∫°n c·∫ßn cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y!');
            });
        } else {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!');
        }
    }

    // === PH·∫¶N B·∫¢N ƒê·ªí (ƒê√É S·ª¨A L·∫†I HO√ÄN CH·ªàNH) ===

    // 1. L·∫•y d·ªØ li·ªáu T·∫§T C·∫¢ tr·∫°m (t·ª´ ModelAttribute "stations")
    const allStations = /*[[${stations}]]*/ [];

    // 2. L·∫•y v·ªã tr√≠ user (s·∫Ω l√† null n·∫øu ch∆∞a t√¨m "nearby")
    const userLat = /*[[${userLat}]]*/ null;
    const userLng = /*[[${userLng}]]*/ null;

    // 3. Khai b√°o bi·∫øn map
    let map = null;

    // H√†m kh·ªüi t·∫°o b·∫£n ƒë·ªì
    function initializeMap() {
        if (map != null) {
            map.remove(); // X√≥a map c≈© n·∫øu c√≥
        }

        let mapCenter;
        let mapZoom;

        // 4. KI·ªÇM TRA: N·∫øu user V·ª™A T√åM "Nearby"
        if (userLat != null && userLng != null) {
            // Th√¨ zoom v√†o v·ªã tr√≠ user
            mapCenter = [userLat, userLng];
            mapZoom = 14; // Zoom g·∫ßn
        } else {
            // 5. N·∫æU KH√îNG (m·ªõi t·∫£i trang)
            // Th√¨ zoom m·∫∑c ƒë·ªãnh (v√≠ d·ª•: th·∫•y r√µ TP.HCM)
            mapCenter = [10.7769, 106.7009]; // (T·ªça ƒë·ªô trung t√¢m TP.HCM)
            mapZoom = 12; // Zoom v·ª´a ph·∫£i
        }

        // 6. T·∫°o map
        map = L.map('map').setView(mapCenter, mapZoom);

        // Th√™m l·ªõp n·ªÅn OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 7. S·ª¨A QUAN TR·ªåNG: L·∫∑p qua T·∫§T C·∫¢ tr·∫°m v√† v·∫Ω marker
        if (allStations && allStations.length > 0) {
            allStations.forEach(station => {
                // ƒê·∫£m b·∫£o tr·∫°m c√≥ t·ªça ƒë·ªô h·ª£p l·ªá
                if (station.latitude && station.longitude) {
                    L.marker([station.latitude, station.longitude]).addTo(map)
                        .bindPopup(`<b>${station.name}</b><br>${station.address}`);
                }
            });
        }

        // 8. KI·ªÇM TRA: N·∫øu user V·ª™A T√åM "Nearby", v·∫Ω th√™m marker ƒê·ªé (v·ªã tr√≠ user)
        if (userLat != null && userLng != null) {
            const userIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            L.marker([userLat, userLng], {icon: userIcon}).addTo(map)
                .bindPopup('<b>V·ªã tr√≠ c·ªßa b·∫°n</b>')
                .openPopup();
        }
    }

    // 9. Ch·∫°y h√†m map NGAY KHI trang ƒë∆∞·ª£c t·∫£i xong
    document.addEventListener('DOMContentLoaded', (event) => {
        initializeMap();
    });
    /*]]>*/
</script>

</body>
</html>