<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω tr·∫°m - EV SWAP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/station.css}">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <style>
        #map {
            height: 450px;
            width: 100%;
            border-radius: 22px;
            margin-top: 24px;
            border: 1px solid var(--border-soft);
            box-shadow: var(--shadow-soft);
            z-index: 5;
        }
    </style>
</head>
<body class="dashboard-body">

<div class="background-gradient"></div>
<div class="background-glow"></div>

<header class="manage-header container">
    <div class="driver-identity">
        <div class="driver-avatar">üìç</div>
        <div class="driver-intro">
            <span class="subtitle">Qu·∫£n l√Ω tr·∫°m</span>
            <h1 class="page-title">EV SWAP Stations</h1>
            <p class="page-hint">
                Theo d√µi th√¥ng tin tr·∫°m, v·ªã tr√≠ v√† b√°n k√≠nh ho·∫°t ƒë·ªông ‚Äì qu·∫£n l√Ω th√¥ng minh cho h·ªá sinh th√°i xanh.
            </p>
        </div>
    </div>
    <div class="header-actions">
        <a class="btn ghost" th:href="@{/dashboard}">Quay v·ªÅ Dashboard</a>
        <button class="btn primary" type="button" onclick="openStationModal()">+ Th√™m tr·∫°m</button>
    </div>
</header>

<main class="manage-main container">
    <div class="alert success" th:if="${stationSuccess}" th:text="${stationSuccess}"></div>
    <div class="alert error" th:if="${stationError}" th:text="${stationError}"></div>

    <div class="station-modal" id="stationModal" aria-hidden="true" role="dialog">
        <div class="modal-backdrop" onclick="closeStationModal()"></div>
        <div class="modal-content" role="document">
            <button class="modal-close" type="button" aria-label="ƒê√≥ng" onclick="closeStationModal()">√ó</button>
            <h2>Th√™m tr·∫°m m·ªõi</h2>
            <form th:action="@{/stations/add}" th:object="${stationForm}" method="post" class="modal-form">
                <div class="form-grid">
                    <label>
                        <span>T√™n tr·∫°m</span>
                        <input type="text" th:field="*{name}" placeholder="V√≠ d·ª•: EV Swap Qu·∫≠n 1" required>
                    </label>
                    <label>
                        <span>ƒê·ªãa ch·ªâ</span>
                        <input type="text" th:field="*{address}" placeholder="V√≠ d·ª•: 123 Nguy·ªÖn Hu·ªá, P. B·∫øn Ngh√©, Q.1" required>
                    </label>
                    <label>
                        <span>Tr·∫°ng th√°i</span>
                        <select th:field="*{status}">
                            <option value="active">Ho·∫°t ƒë·ªông</option>
                            <option value="closed">ƒê√£ ƒë√≥ng</option>
                        </select>
                    </label>
                </div>
                <div class="modal-actions">
                    <button class="btn ghost" type="button" onclick="closeStationModal()">Hu·ª∑</button>
                    <button class="btn primary" type="submit">L∆∞u tr·∫°m</button>
                </div>
            </form>
        </div>
    </div>

    <section class="station-list-section">
        <h2>Danh s√°ch tr·∫°m</h2>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>T√™n tr·∫°m</th>
                <th>ƒê·ªãa ch·ªâ</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${stations == null or stations.isEmpty()}">
                <td colspan="5" style="text-align: center; padding: 32px;">Ch∆∞a c√≥ tr·∫°m n√†o. H√£y th√™m tr·∫°m m·ªõi!</td>
            </tr>
            <tr th:each="station : ${stations}">
                <td th:text="${station.stationId}"></td>
                <td th:text="${station.name}"></td>
                <td th:text="${station.address}"></td>
                <td th:text="${station.status}"></td>
                <td>
                    <a class="btn ghost" th:href="@{|/stations/${station.stationId}|}">Xem</a>
                    <form th:action="@{|/stations/delete/${station.stationId}|}" method="post" style="display:inline;">
                        <button class="btn outline" type="submit" onclick="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° tr·∫°m n√†y?')">Xo√°</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </section>

    <section class="station-detail-section" th:if="${station != null}">
        <h2>Chi ti·∫øt tr·∫°m</h2>
        <ul>
            <li><b>ID:</b> <span th:text="${station.stationId}"></span></li>
            <li><b>T√™n tr·∫°m:</b> <span th:text="${station.name}"></span></li>
            <li><b>ƒê·ªãa ch·ªâ:</b> <span th:text="${station.address}"></span></li>
            <li><b>Tr·∫°ng th√°i:</b> <span th:text="${station.status}"></span></li>
        </ul>
        <a class="btn ghost" href="/stations">Quay l·∫°i danh s√°ch</a>
    </section>

    <section class="station-nearby-section">
        <h2>T√¨m tr·∫°m g·∫ßn v·ªã tr√≠ c·ªßa b·∫°n</h2>
        <form id="nearby-form" method="get" action="/stations/nearby">
            <input type="hidden" name="lat" id="latitude">
            <input type="hidden" name="lng" id="longitude">
            <label for="radius-km">B√°n k√≠nh (km):</label>
            <input type="number" step="any" name="radiusKm" id="radius-km" value="5">
            <button type="button" class="btn primary" onclick="getLocation()">T√¨m tr·∫°m g·∫ßn v·ªã tr√≠ c·ªßa t√¥i</button>
        </form>

        <div id="map" th:if="${userLat != null}"></div>

        <table th:if="${nearbyStations != null and not nearbyStations.isEmpty()}">
            <thead>
            <tr>
                <th>T√™n tr·∫°m</th>
                <th>Kho·∫£ng c√°ch (km)</th>
                <th>ƒê·ªãa ch·ªâ</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="st : ${nearbyStations}">
                <td th:text="${st.name}"></td>
                <td th:text="${#numbers.formatDecimal(st.distance, 1, 2)}"></td>
                <td th:text="${st.address}"></td>
            </tr>
            </tbody>
        </table>
        <div class="alert" th:if="${nearbyStations != null and nearbyStations.isEmpty()}" style="margin-top: 24px; text-align: center;">
            Kh√¥ng t√¨m th·∫•y tr·∫°m n√†o trong b√°n k√≠nh ƒë√£ ch·ªçn.
        </div>
    </section>
</main>

<script th:inline="javascript">
    /*<![CDATA[*/
    function openStationModal() {
        const modal = document.getElementById('stationModal');
        if (modal) {
            modal.setAttribute('aria-hidden', 'false');
            modal.classList.add('is-open');
            document.body.classList.add('modal-open');
        }
    }

    function closeStationModal() {
        const modal = document.getElementById('stationModal');
        if (modal) {
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('is-open');
            document.body.classList.remove('modal-open');
        }
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
                document.getElementById('nearby-form').submit();
            }, function (error) {
                alert('B·∫°n c·∫ßn cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y!');
                console.error("Geolocation error: ", error);
            });
        } else {
            alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã!');
        }
    }

    const nearbyStations = /*[[${nearbyStations}]]*/ [];
    const userLat = /*[[${userLat}]]*/ null;
    const userLng = /*[[${userLng}]]*/ null;
    let map = null;

    function initializeMap() {
        if (userLat != null && userLng != null) {
            if (map != null) {
                map.remove();
            }
            map = L.map('map').setView([userLat, userLng], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const userIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            L.marker([userLat, userLng], {icon: userIcon}).addTo(map)
                .bindPopup('<b>V·ªã tr√≠ c·ªßa b·∫°n</b>')
                .openPopup();

            if (nearbyStations && nearbyStations.length > 0) {
                nearbyStations.forEach(station => {
                    if (station.latitude && station.longitude) {
                        L.marker([station.latitude, station.longitude]).addTo(map)
                            .bindPopup(`<b>${station.name}</b><br>${station.address}`);
                    }
                });
            }
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        initializeMap();
    });
    /*]]>*/
</script>

</body>
</html>