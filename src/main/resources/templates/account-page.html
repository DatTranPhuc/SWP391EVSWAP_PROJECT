<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>T√†i kho·∫£n & Thanh to√°n</title>
    <link rel="stylesheet" th:href="@{/css/account-page.css}">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* CSS n·ªôi b·ªô cho layout (c√≥ th·ªÉ chuy·ªÉn v√†o account-page.css) */
        .account-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 32px;
            align-items: flex-start;
            margin-top: 30px;
        }
        .stat-card .stat-value { font-size: 2.5rem; }
        #qrCodeContainer img {
            max-width: 90%; height: auto; border: none;
            border-radius: var(--radius-md); padding: 8px; background: white;
        }
        @media (max-width: 960px) {
            .account-layout { grid-template-columns: 1fr; }
        }
        /* CSS cho status badge (c√≥ th·ªÉ chuy·ªÉn v√†o account-page.css) */
        .status-badge {
            padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 0.8rem;
            display: inline-block; border: 1px solid currentColor; text-transform: uppercase;
        }
        .status-succeed { background: rgba(34, 197, 94, 0.18); color: #4ade80; }
        .status-pending { background: rgba(234, 179, 8, 0.18); color: #facc15; }
        .status-failed { background: rgba(239, 68, 68, 0.18); color: #f87171; }
        .status-failed_amount_mismatch { background: rgba(239, 68, 68, 0.18); color: #f87171; }
        .status-unknown { background: rgba(148, 163, 184, 0.18); color: #94a3b8; }
    </style>
</head>
<body class="dashboard-body">

<div class="background-gradient"></div>
<div class="background-glow"></div>

<header class="manage-header container">
    <div class="driver-identity">
        <div class="driver-avatar">üí∞</div>
        <div class="driver-intro">
            <span class="subtitle">T√†i kho·∫£n & Thanh to√°n</span>
            <h1 class="page-title">V√≠ EV SWAP</h1>
            <p class="page-hint" th:if="${accountDetails}" th:text="'T√†i kho·∫£n: ' + ${accountDetails.driverName}"></p>
        </div>
    </div>
    <div class="header-actions">
        <a class="btn ghost" th:href="@{/dashboard}">Quay v·ªÅ Dashboard</a>
    </div>
</header>

<main class="manage-main container">
    <div class="alert success" th:if="${accountSuccess}" th:text="${accountSuccess}"></div>
    <div class="alert error" th:if="${accountError != null or qrError != null}" th:text="${accountError ?: qrError}"></div>
    <div class="alert error" th:if="${accountLoadError}" th:text="${accountLoadError}"></div>

    <div class="account-layout" th:if="${accountDetails}">
        <aside class="left-column">
            <div class="stat-card" style="margin-bottom: 24px;">
                <div class="stat-label">S·ªë d∆∞ hi·ªán t·∫°i</div>
                <div class="stat-value" th:text="${accountDetails.formattedBalance}" style="color: var(--accent-success);"></div>
                <div class="stat-caption" th:text="'Email: ' + ${accountDetails.email}"></div>
            </div>

            <h2>N·∫°p ti·ªÅn v√†o v√≠</h2>
            <form th:action="@{/account/deposit/qr}" th:object="${depositForm}" method="post" style="max-width: 100%;">
                <label for="amount">Nh·∫≠p s·ªë ti·ªÅn c·∫ßn n·∫°p (VND)</label>
                <input type="number" id="amount" th:field="*{amount}" min="10000" step="1000" placeholder="V√≠ d·ª•: 50000" required>

                <div th:if="${#fields.hasErrors('amount')}"
                     th:errors="*{amount}"
                     class="alert error"
                     style="padding: 10px; margin-top: 8px; margin-bottom: 8px; font-size: 0.9em;">
                    Validation Error Message
                </div>

                <button class="btn primary" type="submit" style="width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 16px;">
                    T·∫°o m√£ QR N·∫°p ti·ªÅn
                </button>
            </form>
        </aside>

        <section class="right-column">
            <h2>L·ªãch s·ª≠ n·∫°p ti·ªÅn</h2>
            <table>
                <thead>
                <tr>
                    <th>Ng√†y</th>
                    <th>Th·ªùi gian</th>
                    <th>S·ªë ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${paymentHistory == null or paymentHistory.isEmpty()}">
                    <td colspan="4" style="text-align: center; padding: 32px;">Ch∆∞a c√≥ giao d·ªãch n·∫°p ti·ªÅn n√†o.</td>
                </tr>
                <tr th:each="item : ${paymentHistory}">
                    <td th:text="${item.date}"></td>
                    <td th:text="${item.time}"></td>
                    <td th:text="${item.formattedAmount}" style="font-weight: 600; color: var(--accent-success);"></td>
                    <td>
                        <span th:text="${item.status}"
                              th:classappend="|status-${#strings.toLowerCase(item.status)}|"
                              class="status-badge">
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </section>
    </div>
</main>

<div class="station-modal" id="qrModal" aria-hidden="true" role="dialog">
    <div class="modal-backdrop" onclick="closeQrModal()"></div>
    <div class="modal-content" role="document">
        <button class="modal-close" type="button" aria-label="ƒê√≥ng" onclick="closeQrModal()">√ó</button>
        <h2>Qu√©t m√£ QR ƒë·ªÉ n·∫°p ti·ªÅn</h2>
        <p style="text-align: center; color: var(--text-secondary);">D√πng ·ª©ng d·ª•ng ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠ c·ªßa b·∫°n ƒë·ªÉ qu√©t m√£.</p>
        <div id="qrCodeContainer" style="text-align: center; margin: 20px 0; min-height: 200px; display: grid; place-items: center;">
        </div>
        <p id="qrErrorDisplay" style="text-align: center; color: var(--accent-error); font-weight: 500;"></p>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const qrModal = document.getElementById('qrModal');
    const qrContainer = document.getElementById('qrCodeContainer');
    const qrErrorDisplay = document.getElementById('qrErrorDisplay');

    // L·∫•y d·ªØ li·ªáu QR v√† l·ªói t·ª´ Model (do RedirectAttributes g·ª≠i v·ªÅ)
    const qrCodeData = /*[[${qrCodeData}]]*/ null;
    const qrErrorMessage = /*[[${qrError}]]*/ null;

    function openQrModal() {
        if (qrModal) {
            qrModal.setAttribute('aria-hidden', 'false');
            qrModal.classList.add('is-open');
            document.body.classList.add('modal-open');
        }
    }
    function closeQrModal() {
        if (qrModal) {
            qrModal.setAttribute('aria-hidden', 'true');
            qrModal.classList.remove('is-open');
            document.body.classList.remove('modal-open');
            // Reset n·ªôi dung modal khi ƒë√≥ng
            qrContainer.innerHTML = '';
            qrErrorDisplay.textContent = '';
        }
    }

    // X·ª≠ l√Ω hi·ªÉn th·ªã modal t·ª± ƒë·ªông khi trang t·∫£i xong n·∫øu c√≥ d·ªØ li·ªáu QR/l·ªói
    document.addEventListener('DOMContentLoaded', () => {
        if (qrCodeData && qrCodeData.qrCodeUrl) {
            qrContainer.innerHTML = ''; // X√≥a ch·ªØ ch·ªù
            qrErrorDisplay.textContent = '';
            try {
                // T·∫°o QR code t·ª´ URL thanh to√°n VNPay
                new QRCode(qrContainer, {
                    text: qrCodeData.qrCodeUrl,
                    width: 300,
                    height: 300,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    // [ƒê√É S·ª¨A] TƒÉng m·ª©c s·ª≠a l·ªói l√™n H (High)
                    correctLevel : QRCode.CorrectLevel.H
                });
                openQrModal(); // M·ªü modal hi·ªÉn th·ªã QR
            } catch (e) {
                console.error("L·ªói khi t·∫°o QRCode:", e);
                qrErrorDisplay.textContent = 'L·ªói hi·ªÉn th·ªã m√£ QR.';
                openQrModal(); // V·∫´n m·ªü modal ƒë·ªÉ b√°o l·ªói
            }
        } else if (qrErrorMessage) {
            // Hi·ªÉn th·ªã l·ªói n·∫øu c√≥ t·ª´ backend
            qrContainer.innerHTML = '';
            qrErrorDisplay.textContent = qrErrorMessage;
            openQrModal();
        }
    });
    /*]]>*/
</script>

</body>
</html>